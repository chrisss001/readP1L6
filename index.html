<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒŸ åæ–‡è¯†å­—å¤§é—¯å…³ (å¢å¼ºè¯Šæ–­ç‰ˆ) ğŸŒŸ</title>
<style>
    body { text-align: center; font-family: "Microsoft YaHei", sans-serif; background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .card { background: white; width: 90%; max-width: 550px; padding: 40px 20px; border-radius: 50px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 10px solid #FFF; }
    h2 { color: #FF7E5F; margin-bottom: 10px; }
    
    /* æ ¸å¿ƒåé¦ˆï¼šéŸ³é‡æ¡ */
    .mic-monitor { width: 150px; height: 8px; background: #eee; margin: 10px auto; border-radius: 10px; overflow: hidden; display: none; }
    #vol-bar { width: 0%; height: 100%; background: #2ed573; transition: width 0.1s; }

    #word { font-size: 100px; margin: 20px 0; font-weight: bold; color: #333; text-shadow: 4px 4px 0px #FFD1D1; min-height: 130px; display: flex; justify-content: center; align-items: center; }
    #pinyin { font-size: 32px; color: #48C6EF; font-weight: bold; height: 40px; }
    #status { font-size: 16px; color: #777; background: #F0F8FF; padding: 8px 15px; border-radius: 20px; margin: 10px; display: inline-block; }
    
    button { padding: 15px 35px; font-size: 22px; border: none; border-radius: 40px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; box-shadow: 0 6px 0px #CCC; }
    #startBtn { background: #ff9a9e; box-shadow: 0 8px 0px #f6416c; }
    #nextBtn { background: #667eea; box-shadow: 0 8px 0px #764ba2; }
    
    /* é—ªåŠ¨å½©è™¹æ–‡å­— */
    .reward-text { font-size: 36px; font-weight: bold; background: linear-gradient(to right, #ff4757, #ffa502, #2ed573, #1e90ff, #ff4757); background-size: 200% auto; -webkit-background-clip: text; color: transparent; animation: shimmer 1.5s linear infinite; margin: 15px 0; }
    @keyframes shimmer { 0% { filter: brightness(1); transform: scale(1); background-position: 0% center; } 50% { filter: brightness(1.3); transform: scale(1.1); background-position: 100% center; } 100% { filter: brightness(1); transform: scale(1); background-position: 200% center; } }
</style>
</head>
<body>

<div class="card">
    <h2>ğŸ¦ åæ–‡è¯†å­—å¤§é—¯å…³ ğŸ¦</h2>
    
    <div class="mic-monitor" id="monitor-box">
        <div id="vol-bar"></div>
    </div>
    <div id="status">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•éº¦å…‹é£</div>

    <div id="word">Ready?</div>
    <div id="pinyin"></div>
    <div id="reward"></div>

    <div id="btnGroup">
        <button onclick="activateGame()" id="startBtn">ğŸš€ å¯åŠ¨å¹¶å¼€å§‹</button>
        <button onclick="nextWord()" id="nextBtn" style="display:none;">ä¸‹ä¸€é¢˜ âœ</button>
    </div>
</div>

<script>
const words = [
    {han:"å°é¸Ÿ", py:"xiÇo niÇo"}, {han:"å¤§å®¶", py:"dÃ  jiÄ"}, {han:"ä¸Šæ¥", py:"shÃ ng lÃ¡i"}
];
let index = 0;
let recognition;

// 1. å¼ºåˆ¶æ¿€æ´»éº¦å…‹é£å’ŒéŸ³é‡ç›‘æ§
async function activateGame() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById("monitor-box").style.display = "block";
        
        // éŸ³é‡å¯è§†åŒ–æµ‹è¯•
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function draw() {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let average = sum / dataArray.length;
            document.getElementById('vol-bar').style.width = Math.min(average * 2.5, 100) + "%";
            requestAnimationFrame(draw);
        }
        draw();

        // 2. åˆå§‹åŒ–è¯†åˆ«å¼•æ“
        initSpeech();
        
        document.getElementById("startBtn").style.display = "none";
        showWord();
    } catch (err) {
        alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦åœ¨ Chrome/Edge æµè§ˆå™¨æ‰“å¼€\n2. éº¦å…‹é£æ’å¤´æ˜¯å¦æ’å¥½\n3. ç½‘é¡µæ˜¯å¦å¼€å¯äº† HTTPSï¼ˆæˆ–æ˜¯æœ¬åœ°æ–‡ä»¶ï¼‰");
        document.getElementById("status").innerText = "âŒ ç¡¬ä»¶è¿æ¥é”™è¯¯";
    }
}

function initSpeech() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = "zh-CN";
    recognition.continuous = false;

    recognition.onresult = (event) => {
        let result = event.results[0][0].transcript;
        if (result.includes(words[index].han)) {
            success();
        } else {
            document.getElementById("status").innerText = "å¬åˆ°äº†: " + result + "ï¼Œå†è¯•ä¸€æ¬¡";
        }
    };

    recognition.onend = () => {
        // å¦‚æœæ²¡è¿‡å…³ï¼Œä¸”åœ¨æ¸¸æˆä¸­ï¼Œè‡ªåŠ¨é‡å¯
        if (document.getElementById("nextBtn").style.display === "none") {
            recognition.start();
        }
    };
}

function showWord() {
    document.getElementById("word").innerText = words[index].han;
    document.getElementById("pinyin").innerText = "";
    document.getElementById("reward").innerHTML = "";
    document.getElementById("status").innerText = "ğŸ¤ æ­£åœ¨å€¾å¬ï¼Œè¯·å¤§å£°è¯»å‡ºæ¥...";
    document.getElementById("nextBtn").style.display = "none";
    recognition.start();
}

function success() {
    document.getElementById("pinyin").innerText = words[index].py;
    document.getElementById("status").innerText = "âœ… è¯»å¯¹å•¦ï¼";
    document.getElementById("reward").innerHTML = "<div class='reward-text'>â­ å¤ªæ£’äº† â­</div>";
    document.getElementById("nextBtn").style.display = "inline-block";
}

function nextWord() {
    index++;
    if (index < words.length) showWord();
    else {
        document.getElementById("word").innerText = "ğŸ†";
        document.getElementById("status").innerText = "å…¨éƒ¨é€šå…³ï¼";
        document.getElementById("nextBtn").style.display = "none";
    }
}
</script>
</body>
</html>